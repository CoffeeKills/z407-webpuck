<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Z407 Control Dial</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Lively Light Theme (Default) */
            --bg: #e6eef5;
            --surface: #e6eef5;
            --text: #4a5568;
            --shadow-light: #ffffff;
            --shadow-dark: #a6b0c3;
            --accent: #6d5dfc;
            --dial-size: 360px;
            --led-off: #ccc;
        }

        [data-theme="dark"] {
            /* Logitech-inspired Dark Theme */
            --bg: #121212;
            --surface: #1a1a1a;
            --text: #e0e0e0;
            --shadow-light: #2a2a2a;
            --shadow-dark: #050505;
            --accent: #00B8FC;
            /* Electric Blue */
            --led-off: #444;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
            perspective: 1000px;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Top Bar Controls --- */
        .top-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 200;
        }

        .icon-btn {
            background: var(--surface);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            color: var(--text);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 5px 5px 10px var(--shadow-dark),
                -5px -5px 10px var(--shadow-light);
            transition: all 0.2s;
        }

        .icon-btn:active,
        .icon-btn.active {
            box-shadow: inset 3px 3px 6px var(--shadow-dark),
                inset -3px -3px 6px var(--shadow-light);
            color: var(--accent);
        }

        /* --- Main Container --- */
        .control-unit {
            position: relative;
            width: var(--dial-size);
            height: var(--dial-size);
            border-radius: 50%;
            background: var(--surface);
            box-shadow: 20px 20px 60px var(--shadow-dark),
                -20px -20px 60px var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s ease-out, box-shadow 0.3s;
        }

        /* --- Outer Volume Ring --- */
        .volume-ring {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            /* Flat look, no gradient needed if we want clean */
            background: var(--surface);
            z-index: 1;
            cursor: grab;
        }

        /* Marker */
        .volume-ring::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
            transition: background 0.3s, box-shadow 0.3s;
        }

        .volume-ring:active {
            cursor: grabbing;
        }

        /* --- Inner Static Zone (Buttons) --- */
        .inner-zone {
            position: absolute;
            width: 68%;
            height: 68%;
            border-radius: 50%;
            background: var(--surface);
            z-index: 2;
            /* Removed inset shadow for flatter look */
            /* box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light); */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Center Play Button --- */
        .center-btn {
            width: 38%;
            height: 38%;
            border-radius: 50%;
            border: none;
            background: var(--surface);
            color: var(--text);
            font-size: 2rem;
            cursor: pointer;
            z-index: 10;
            box-shadow: 6px 6px 12px var(--shadow-dark),
                -6px -6px 12px var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }

        .center-btn:active {
            box-shadow: inset 3px 3px 6px var(--shadow-dark),
                inset -3px -3px 6px var(--shadow-light);
            color: var(--accent);
        }

        /* --- Radial Buttons --- */
        .radial-btn {
            position: absolute;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--surface);
            color: var(--text);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 4px 4px 8px var(--shadow-dark),
                -4px -4px 8px var(--shadow-light);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .radial-btn:active {
            box-shadow: inset 2px 2px 4px var(--shadow-dark),
                inset -2px -2px 4px var(--shadow-light);
            color: var(--accent);
            transform: scale(0.95);
        }

        /* Positioning */
        .pos-top {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        /* BT */
        .pos-top-left {
            top: 35px;
            left: 35px;
        }

        /* AUX */
        .pos-top-right {
            top: 35px;
            right: 35px;
        }

        /* USB */

        .pos-bottom {
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        /* Pair */
        .pos-bottom-left {
            bottom: 35px;
            left: 35px;
        }

        /* Bass - */
        .pos-bottom-right {
            bottom: 35px;
            right: 35px;
        }

        /* Bass + */

        .pos-left {
            top: 50%;
            left: 5px;
            transform: translateY(-50%);
        }

        .pos-right {
            top: 50%;
            right: 5px;
            transform: translateY(-50%);
        }


        /* --- Overlay --- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(224, 229, 236, 0.2);
            /* Very subtle */
            backdrop-filter: blur(4px);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .connect-btn {
            padding: 15px 40px;
            border-radius: 30px;
            border: none;
            background: var(--surface);
            color: var(--text);
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            box-shadow: 8px 8px 16px var(--shadow-dark),
                -8px -8px 16px var(--shadow-light);
            transition: all 0.2s;
        }

        .connect-btn:active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            color: var(--accent);
        }

        .status-led {
            position: absolute;
            top: -40px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--led-off);
            transition: background 0.3s, box-shadow 0.3s;
        }

        .status-led.connected {
            background: var(--accent);
            box-shadow: 0 0 10px var(--accent);
        }
    </style>
</head>

<body>

    <div class="top-controls">
        <button id="themeBtn" class="icon-btn" title="Toggle Theme">‚óë</button>
        <button id="devBtn" class="icon-btn" title="Dev Mode (Bypass Connect)">üõ†</button>
    </div>

    <div id="overlay" class="overlay">
        <button id="connectBtn" class="connect-btn">CONNECT SPEAKER</button>
    </div>

    <div class="control-unit" id="controlUnit">
        <div class="status-led" id="led"></div>

        <!-- Outer Ring (Rotates) -->
        <div class="volume-ring" id="volumeRing"></div>

        <!-- Inner Zone (Static) -->
        <div class="inner-zone">

            <!-- Center -->
            <button id="btn-play" class="center-btn" title="Play/Pause">‚èØ</button>

            <!-- Surrounding Buttons -->
            <button id="btn-bt" class="radial-btn pos-top" title="Bluetooth">BT</button>
            <button id="btn-aux" class="radial-btn pos-top-left" title="AUX">AUX</button>
            <button id="btn-usb" class="radial-btn pos-top-right" title="USB">USB</button>

            <button id="btn-prev" class="radial-btn pos-left" title="Previous">‚èÆ</button>
            <button id="btn-next" class="radial-btn pos-right" title="Next">‚è≠</button>

            <button id="btn-pair" class="radial-btn pos-bottom" title="Pairing">‚àû</button>
            <button id="btn-bass-down" class="radial-btn pos-bottom-left" title="Bass -">-</button>
            <button id="btn-bass-up" class="radial-btn pos-bottom-right" title="Bass +">+</button>

        </div>
    </div>

    <script>
        // --- Theme Logic ---
        const themeBtn = document.getElementById('themeBtn');
        themeBtn.addEventListener('click', () => {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        });

        // --- Dev Mode Logic ---
        const devBtn = document.getElementById('devBtn');
        let devMode = false;
        devBtn.addEventListener('click', () => {
            devMode = !devMode;
            devBtn.classList.toggle('active', devMode);

            if (devMode) {
                // Fake connection
                document.getElementById('overlay').classList.add('hidden');
                document.getElementById('led').classList.add('connected');
                console.log("Dev Mode: Enabled");
            } else {
                // Disconnect if not actually connected
                if (!commandCharacteristic) {
                    document.getElementById('overlay').classList.remove('hidden');
                    document.getElementById('led').classList.remove('connected');
                }
                console.log("Dev Mode: Disabled");
            }
        });

        // --- 3D Tilt ---
        const unit = document.getElementById('controlUnit');
        document.addEventListener('mousemove', (e) => {
            const x = (e.clientX / window.innerWidth - 0.5) * 2;
            const y = (e.clientY / window.innerHeight - 0.5) * 2;
            unit.style.transform = `rotateX(${-y * 3}deg) rotateY(${x * 3}deg)`;
        });

        // --- Volume Ring Logic ---
        const ring = document.getElementById('volumeRing');
        let isDragging = false;
        let startAngle = 0;
        let currentRotation = 0;
        let lastSentRotation = 0;

        function getAngle(x, y, cx, cy) {
            return Math.atan2(y - cy, x - cx) * 180 / Math.PI;
        }

        const startDrag = (e) => {
            isDragging = true;
            const rect = ring.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startAngle = getAngle(clientX, clientY, cx, cy) - currentRotation;
            e.preventDefault();
        };

        const drag = (e) => {
            if (!isDragging) return;
            const rect = ring.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            currentRotation = getAngle(clientX, clientY, cx, cy) - startAngle;
            ring.style.transform = `rotate(${currentRotation}deg)`;

            const delta = currentRotation - lastSentRotation;
            if (delta > 15) { send(COMMANDS.VOLUME_UP); lastSentRotation = currentRotation; }
            else if (delta < -15) { send(COMMANDS.VOLUME_DOWN); lastSentRotation = currentRotation; }
        };

        const endDrag = () => { isDragging = false; };

        ring.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', endDrag);
        ring.addEventListener('touchstart', startDrag);
        document.addEventListener('touchmove', drag);
        document.addEventListener('touchend', endDrag);


        // --- Bluetooth Logic ---
        const SERVICE_UUID = '0000fdc2-0000-1000-8000-00805f9b34fb';
        const COMMAND_UUID = 'c2e758b9-0e78-41e0-b0cb-98a593193fc5';
        const RESPONSE_UUID = 'b84ac9c6-29c5-46d4-bba1-9d534784330f';

        const COMMANDS = {
            INITIATE: new Uint8Array([0x84, 0x05]),
            ACKNOWLEDGE: new Uint8Array([0x84, 0x00]),
            VOLUME_UP: new Uint8Array([0x80, 0x02]),
            VOLUME_DOWN: new Uint8Array([0x80, 0x03]),
            BASS_UP: new Uint8Array([0x80, 0x00]),
            BASS_DOWN: new Uint8Array([0x80, 0x01]),
            PLAY_PAUSE: new Uint8Array([0x80, 0x04]),
            NEXT_TRACK: new Uint8Array([0x80, 0x05]),
            PREV_TRACK: new Uint8Array([0x80, 0x06]),
            SWITCH_BLUETOOTH: new Uint8Array([0x81, 0x01]),
            SWITCH_AUX: new Uint8Array([0x81, 0x02]),
            SWITCH_USB: new Uint8Array([0x81, 0x03]),
            PAIRING: new Uint8Array([0x82, 0x00]),
        };

        let commandCharacteristic = null;
        const overlay = document.getElementById('overlay');
        const led = document.getElementById('led');

        async function connect() {
            if (!navigator.bluetooth) return alert('Web Bluetooth not supported.');
            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }] });
                device.addEventListener('gattserverdisconnected', () => {
                    if (!devMode) {
                        overlay.classList.remove('hidden');
                        led.classList.remove('connected');
                    }
                    commandCharacteristic = null;
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                const responseChar = await service.getCharacteristic(RESPONSE_UUID);
                commandCharacteristic = await service.getCharacteristic(COMMAND_UUID);

                await responseChar.startNotifications();
                responseChar.addEventListener('characteristicvaluechanged', (e) => {
                    const hex = Array.from(new Uint8Array(e.target.value.buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
                    if (hex === 'd40501') commandCharacteristic.writeValueWithoutResponse(COMMANDS.ACKNOWLEDGE);
                    else if (hex === 'd40001' || hex === 'd40003') {
                        overlay.classList.add('hidden');
                        led.classList.add('connected');
                    }
                });

                await commandCharacteristic.writeValueWithoutResponse(COMMANDS.INITIATE);
            } catch (e) { console.error(e); }
        }

        async function send(cmd) {
            if (commandCharacteristic) {
                await commandCharacteristic.writeValueWithoutResponse(cmd);
            } else if (devMode) {
                console.log("Dev Mode: Command Sent", cmd);
                // Visual feedback in dev mode
                led.style.boxShadow = '0 0 20px var(--accent)';
                setTimeout(() => led.style.boxShadow = '0 0 10px var(--accent)', 100);
            } else {
                led.style.backgroundColor = '#e53e3e';
                setTimeout(() => led.style.backgroundColor = 'var(--led-off)', 200);
            }
        }

        // --- Bindings ---
        document.getElementById('connectBtn').addEventListener('click', connect);
        const bind = (id, cmd) => document.getElementById(id).addEventListener('click', (e) => {
            e.stopPropagation();
            send(cmd);
        });

        bind('btn-play', COMMANDS.PLAY_PAUSE);
        bind('btn-next', COMMANDS.NEXT_TRACK);
        bind('btn-prev', COMMANDS.PREV_TRACK);
        bind('btn-bt', COMMANDS.SWITCH_BLUETOOTH);
        bind('btn-aux', COMMANDS.SWITCH_AUX);
        bind('btn-usb', COMMANDS.SWITCH_USB);
        bind('btn-bass-up', COMMANDS.BASS_UP);
        bind('btn-bass-down', COMMANDS.BASS_DOWN);
        bind('btn-pair', COMMANDS.PAIRING);

    </script>
</body>

</html>